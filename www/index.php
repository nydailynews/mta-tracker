<!DOCTYPE HTML>
<html lang="en">
<head>
    <title>TITLE</title>
    <link rel="icon" type="image/png" href="http://interactive.nydailynews.com/favicons.png">
    <!-- DEFAULT -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <link rel="apple-touch-icon" href="">
    <meta name="format-detection" content="telephone=no" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

    <!-- Titles -->
    <meta property="og:title" content='TITLE' />
    <meta name="twitter:title" content='TITLE' />

    <!-- DESCRIPTION -->
    <meta name="description" content="DESC" />
    <meta property="og:description" content="DESC" />
    <meta name="twitter:description" content="DESC" />

    <!-- KEYWORD -->
    <meta name="keywords" content="TAGS" />
    <meta name="news_keywords" content="TAGS" />

    <!-- LINK -->
    <link rel="canonical" href="CANONICAL">
    <meta property="og:url" content="CANONICAL" />
    <meta name="twitter:url" content="CANONICAL" />

    <!-- THUMBNAIL IMAGE-->
    <meta property="og:image" content="static/img/share.png" />
    <meta name="twitter:image" content="static/img/share.png" />
    <meta name="twitter:image:alt" content="A description of the twitter image" />
    <meta property="og:image:width" content="1024" />
    <meta property="og:image:height" content="512" />

    <!-- PARSELY -->
    <script type="application/ld+json">
        {
            "@context": "http://schema.org",
            "@type": "NewsArticle",
            "headline": "TITLE",
            "url": "CANONICAL",
            "thumbnailUrl": "static/img/share.png",
            "dateCreated": "2017-07-12T06:00:00Z",
            "articleSection": "Interactive",
            "creator": ["Reporter Name", "Interactive Project"],
            "keywords": ["interactive project","interactive"]
        }
    </script>

    <!-- NO NEED TO FILL -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:domain" content="http://interactive.nydailynews.com"/>
    <meta name="twitter:site" content="@nydailynews">
    <meta name="twitter:creator" content="@nydailynews">
    <meta name="decorator" content="responsive" />
    <meta name="nydn_section" content="NY Daily News" />
    <meta name="msvalidate.01" content="02916AAC0DA8B068EFE01D721E03ED7E" />
    <meta name="p:domain_verify" content="78efe4f5c9935744af497772f68a0ee7" />
    <meta property="fb:app_id" content="107464888913" />
    <meta property="fb:admins" content="1594068001" />
    <meta property="fb:pages" content="268914272540" />
    <meta property="og:type" content="article" />
    <meta property="og:site_name" content="NY Daily News" />
    <meta property="article:publisher" content="https://www.facebook.com/NYDailyNews/" />
    <meta name="localeCountry" content="US"/>
    <meta name="localeLanguage" content="en" />

    <!-- ADOBE ANALYTICS -->
    <script src="//assets.adobedtm.com/4fc527d6fda921c80e462d11a29deae2e4cf7514/satelliteLib-c91fdc6ac624c6cbcd50250f79786de339793801.js"></script>

    <link href='https://fonts.googleapis.com/css?family=Open%20Sans|Open+Sans+Condensed:300,700|PT+Serif' rel='stylesheet' type='text/css'>
    <script data-main="http://assets.nydailynews.com/nydn/js/rh.js?r=20170405001" src="http://assets.nydailynews.com/nydn/js/require.js?r=2016LIST" defer></script>
      
    <script>
        var nydn = nydn || {
            "section": "NYDailyNews",
            "subsection": "news",
            "template": "article",
            "revision": "201609014009",
            "bidder": { contains: function() {} },
            "targetPath": document.location.pathname
        };
        var nydnDO = [ { 
            'title':'xxxTITLExxx', 
            'link':'CANONICAL', 
            'p_type':'interactive', 
            'section':'interactive' 
        }];
    </script>
    
    <!-- ADS-START -->
    <script onload="nydn_ads('one');" src="http://interactive.nydailynews.com/includes/ads/ads.js"></script>
    <!-- ADS-END -->

    <script src="http://interactive.nydailynews.com/js/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="http://assets.nydailynews.com/nydn/c/rh.css">
    <link rel="stylesheet" type="text/css" href="http://assets.nydailynews.com/nydn/c/ra.css">
    <link rel="stylesheet" type="text/css" href="/static/css/style.css">

    <script>var nav_params = {section: 'projects', url: 'http://interactive.nydailynews.com/project/'};</script>
    <script src="http://interactive.nydailynews.com/library/vendor-nav/vendor-include.js" defer></script>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script>
</script>
</head>
<body id="nydailynews" data-section="nydailynews" data-subsection="NY Daily News">

<!-- SITEHEADER-START -->
<header id="templateheader"></header>
<!-- SITEHEADER-END -->

<!-- CONTENT-START -->
<main>
    <article>
        <section id="lead">
            <h1>MTA tracker</h1>
            <h2 id="timer-text"></h2>
            <p>since the last MTA subway service alert</p>
        </section>
        <hr>
        <section class="recent" id="recent">
            <h2>Recent MTA alerts</h2>
            <div>
                <dl>
                </dl>
            </div>
        </section>
    
        <div class="ad center">
            <span>ADVERTISEMENT</span>
            <div id='div-gpt-ad-1423507761396-1'>
              <script>
                googletag.cmd.push(function() { googletag.display('div-gpt-ad-1423507761396-1'); });
              </script>
            </div>
        </div>

        <section id="news" class="recent">
            <h2>Recent MTA news</h2>
        </section>
    </article>
</main>

<div class="ad center">
    <span>ADVERTISEMENT</span>
    <div id='div-gpt-ad-1423507761396-3'>
      <script>
        googletag.cmd.push(function() { googletag.display('div-gpt-ad-1423507761396-3'); });
      </script>
    </div>
</div>

<div class="ad center">
    <span>ADVERTISEMENT</span>
    <div id='div-gpt-ad-x105'>
      <script>
        googletag.cmd.push(function() { googletag.display('div-gpt-ad-x105'); });
      </script>
    </div>
</div>

<script>
function startTime() {
    var today = new Date();
    var h = today.getHours();
    var m = today.getMinutes();
    var s = today.getSeconds();
    m = checkTime(m);
    s = checkTime(s);
    document.getElementById('timer-text').innerHTML =
    h + ":" + m + ":" + s;
    var t = setTimeout(startTime, 500);
}

var tracker = {
    now: Date.now(),
    tz_offset: -6,
    calc_time_zone: function(offset) {
        // Get the current time in a different timezone. Must know the tz offset,
        // i.e. the number of hours ahead or behind GMT.
        var d = new Date();
        var utc = d.getTime() - (d.getTimezoneOffset() * 60000);
        return new Date(utc + (3600000*offset));
    },
    add_zero: function(i) {
        // For values less than 10, return a zero-prefixed version of that value.
        if ( i < 10 ) return "0" + i;
        return i;
    },
    count_up: function() {
        // Handle the parsing and passage of time.
        // Loop through each of the <time> elements on the page and update them.
        var times = document.querySelector('time');
        $('time').each( function(i) {
            var time = $(this).text();
            var time_parts = time.split(':');
            if ( time_parts.length == 3 ) var secs = +time_parts[2], mins = +time_parts[1], hours = +time_parts[0];
            if ( time_parts.length == 2 ) var secs = +time_parts[1], mins = +time_parts[0], hours = 0;
            secs += 1;
            if ( secs > 59 )
            {
                secs = 0;
                mins += 1;
                if ( mins > 59 )
                {
                    mins = 0;
                    hours += 1;
                }
            }
            if ( hours > 0 ) time = hours + ':' + tracker.add_zero(mins) + ':' + tracker.add_zero(secs);
            else time = tracker.add_zero(mins) + ':' + tracker.add_zero(secs);
            $(this).text(time);
        });
    },
    calc_time_since: function(time) {
        return Math.floor((Date.now() - Date.parse(time))/1000);
    },
    convert_seconds: function(sec) {
        // Turns an integer into the representative number of minutes and hours.
        var hours = Math.floor(sec/3600);
        var minutes = Math.floor((sec-hours*3600)/60);
        var secs = sec%60;
        if ( minutes < 10 ) minutes = "0" + minutes;
        if ( secs < 10 ) secs = "0" + secs;
        if ( hours > 0 ) return hours + ':' + minutes + ':' + secs;
        return minutes + ':' + secs;
    },
    update_timer: function(id, value) {
        document.getElementById(id).innerHTML = value;
    },
    lines: {
        subway: {
            worsts: []
        }
    },
    update_recent: function() {
        // Write the list of recent alerts
        Array.prototype.forEach.call(this.sorted, function(item, i) {
            var l = item['line'];
            if ( tracker.lines.subway.worsts.indexOf(l) > -1 ) return false;

            var markup = '<dt><img src="img/line_' + l + '.png" alt="MTA ' + l + ' line icon"></dt>\n\
                <dd><time id="line-' + l + '">' + tracker.convert_seconds(item['ago']) + '</time> since last alert</dd>';
            $('#recent dl').append(markup);
        });
        window.setInterval("tracker.count_up()", 1000);
    },
    update_lead_nonzero: function() {
        // Write the lead and start the timer.
        // The worst time will be the first item in the sorted array
        $('#lead h1').text('MTA Tracker');
        this.update_timer('timer-text', '<time>' + this.convert_seconds(this.sorted[0]['ago']) + '</time>');
        // Update the p text
        var s = '';
        if ( this.lines.subway.worsts.length > 1 ) s = 's';
        $('#lead p').text('since the last MTA subway service alert.');
        $('#lead p').after('<p>Latest service alert' + s + ' were for the ' + this.lines.subway.worsts.join(' and ') + '&nbsp;line' + s + '.</p>');
    },
    update_lead_zero: function() {
        // Write the lead text and timer.
        $('#lead h1').text('Is there a current MTA service alert?');
        this.update_timer('timer-text', 'YES');
        // Update the p text
        var s = '';
        if ( this.lines.subway.worsts.length > 1 ) s = 's';
        $('#lead p').text('');
        $('#lead p').after('<p>Current service alert' + s + ' now for the ' + this.lines.subway.worsts.join(' and ') + '&nbsp;line' + s + '.</p>');
    },
    init: function() {
        //startTime();
        console.log(this.data);
        // Loop through the data.
        // Figure out the last alert, also, add some helper attributes to the data.
        //
        // If a line has a value of -1 in its stop field, that means it's a current alert
        // and the timer should be zero and stay at zero.
        is_zero = 0;
        worst = { stop: '' };
        worsts = [];
        Array.prototype.forEach.call(this.data, function(item, i) {

            // Add the time since to each item
            tracker.data[i]['ago'] = tracker.calc_time_since(item['stop']);

            if ( item['stop'] === -1 ) {
                // If this is our first current alert, we reset the worsts array,
                // just in case there's some older alert already in it.
                if ( is_zero === 0 ) worsts = [item['line']];
                else worsts.push(item['line']);
                is_zero = 1;
            }

            // Log the current worst, in the case there are no active alerts.
            // We use this to populate the lead time when there are no active alerts.
            if ( is_zero == 0 ) {
                //console.log(item['stop'] > worst['stop'],item['stop'], worst['stop'])
                if ( item['stop'] > worst['stop'] ) {
                    worst = item;
                    worsts = [item['line']];
                }
                // In case we have multiple alerts that ended at the same time
                if ( item['stop'] == worst['stop'] && worsts.indexOf(item['line']) === -1 ) worsts.push(item['line']);
            }
            console.log(i, item['line'], item['stop']);
        });
        // Sort the data
        this.sorted = this.data.sort(function(a, b) { return a.ago - b.ago });

        // Take the final worsts array and assign that to the object for later.
        this.lines.subway.worsts = worsts;
        if ( is_zero == 1 ) this.update_lead_zero();
        else this.update_lead_nonzero();
        
        this.update_recent();
    }
};

$.getJSON('data/current.json', function(data) {
    tracker.data = data;
    tracker.init();
});
</script>
<!-- CONTENT-END -->

<!-- FOOTER-START -->
<footer id="templatefooter"></footer>
<!-- FOOTER-END -->
<div id="ra-bp">
      </div> <section id="rao">  <div id="rao-close"></div> <div id="rao-wrap"></div> </section>
</div>
<div id="r-scripts">
    <div id="parsely-root" style="display: none">
        <span id="parsely-cfg" data-parsely-site="nydailynews.com"></span>
    </div>
    <div class="r-ad">
        <div id="div-gpt-ad-x100">
        </div>
    </div>
</div>
</body>
</html>
